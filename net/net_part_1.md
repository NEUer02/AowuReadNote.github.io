# 网络是如何连接的

参考书目：《网络是如何连接的》 户根勤  

本页内容来自于个人学习笔记与感悟。 
仅限于学习交流，请勿商用。

[TOC]

## 第一章

### 1-1 从浏览器开始

网络连接从输入**网址**（**URL**, Uniform Resource Locator, 统一资源定位符）开始。不论是我们在浏览器上直接输入网址，还是点击网页中的链接，本质上都是在不同的网址之间跳转。所以本书就从浏览器的工作开始介绍网络是如何连接的。 
当你在浏览器中输入网址之后，浏览器的工作步骤如下：

1. **解析**输入的网址；
2. 根据当前情况与URL中涉及的相关协议生成**请求消息**；
3. 接收、解析收到的**响应消息**；

接下来对于上述步骤进行进一步的描述。  

#### 1-1-1 解析网址

在浏览器中可以输入的网址种类有很多，例如“http://......”、“ftp://......”和“file://......”等等。其中“http:”、“ftp:”和“file:”这部分字段表示需要浏览器使用的访问方法（协议）。例如访问Web网站一般使用HTTP（HTTP, Hypertext Transfer Protocol, 超文本传输协议）协议，访问FTP服务器一般使用FTP协议......不同的协议所需要的后续字段是不同的，结构上也有些许的差别。 
浏览器解析网址的过程也就是从网址的不同字段中提取出所需要的信息，以便于生成向服务器发送的请求消息。 
以访问Web服务器为例，即使用HTTP协议： 
一般网址格式为http://user:password@www.xxxx.com:80/dir/file1.htm，其对应的字段含义如下：

| 协议   | 用户名（可省略） | 密码 （可省略） | Web服务器域名     | 端口（可省略） | 文件路径名（可省略）     |
| ---- | -------- | -------- | ------------ | ------- | -------------- |
| http | user     | password | www.xxxx.com | 80      | /dir/file1.htm |

相对应的解释为：根据“HTTP”规定的格式和步骤，使用“user”和“password”从“80端口”登录“www.xxxx.com”，对“/dir/file1.htm”下的文件进行操作。

例如网址"http://www.baidu.com"可以解释为使用HTTP协议访问地址为"www.baidu.com"的Web服务器。其中用户名、密码、端口号和文件路径均被省略。

- 关于端口： 
  不同的服务器程序会使用不同的端口编号，例如Web服务使用80端口，邮件端口为25端口等等。后续会有更详细的介绍。

- 关于路径名： 
  路径名称可以有不同程度上的省略。有以下几种情况： 
  1、什么都不写，例如"http://www.baidu.com"； 
  2、只写根目录，例如"http://www.baidu.com/"； 
  3、没有明确表示文件或文件夹，例如"http://www.lab.glasscom.com/whatisthis"； 
  针对第一、二种情况，Web服务器会返回设置的默认文件，类似于index.html或default.html等这类的文件。这个默认文件也被称为主页（home page），不过现在这个词已经有点被玩坏了...... 
  针对于第三种情况，按照惯例来说，文件系统中不应存在同名的文件和文件夹，所以直接去路径下寻找，如果是文件夹就按照文件夹处理，如果是文件就按照文件处理。

#### 1-1-2 生成请求消息

根据1.1.1节的网址解析过程，浏览器已经知道要访问的目标在哪里了，之后会根据HTTP协议去访问相应的Web服务器。具体的过程分为两个步骤：  

1. 生成请求消息并发送给服务器；
2. 接收服务器的响应消息并进行有关操作。

本节便重点介绍第一步，即生成请求消息。 
请求消息中包含三个部分：

1. 方法（也叫HTTP谓词、HTTP动词），即“进行怎样的操作”；
2. URI（URI, Uniform Resource Identifier, 统一资源标识符），即“对哪个对象”；
3. 消息头（其中每一行包含一个头字段）；

首先发送HTTP动词，再发送URI，下一行紧跟消息头，再经过一个空行后，为从客户端发向服务器的数据。  

![请求消息](../data/picture/net/请求消息.png)

URI一般是存放网页数据的文件名或者一个CGI程序。 

“方法”表示需要让Web服务器完成怎样的工作，例如：读取URI指向的文件、将客户端数据发送到URI指向的程序等等（还有很多方法，可以参考参考书目第12页，在此不多赘述）。 关于方法的选择关键在于浏览器的工作状态。选取哪种方法也是根据场景来决定的。

- HTTP协议中提供了很多可用的方法，具体可见参考书目第十二页表1.1 
  
  这里重点介绍两种常用的方法。GET方法和POST方法。
  
  GET方法指获取URI指向的信息。如果URI指向的是文件，则返回文件的内容；如果URI指向的是程序，则返回程序的输出数据。
  
  POST方法是从客户端向服务器发送数据，一般用于发送表单中填写的数据等情况。例如在网站上填写调查问卷，点击“提交”时，便会调用该方法。

#### 1-1-3 接收响应消息

当我们将上述的请求消息发出后，Web服务器会返回一个响应消息。第六章会有更加详细的解释，这里将简单的介绍一下。响应消息的格式与请求消息大同小异。具体格式如图所示：

![响应消息](../data/picture/net/响应消息.png)

这里需要注意，在请求消息中，HTTP版本在最后面，而在响应消息中，HTTP版本在最前面。

状态码与响应短语对应，均用于表示请求的执行结果是成功还是出错。区别在于，状态码是一个数字，主要用于向机器表示执行结果；而响应短语是一段文字，主要用于向人表示执行结果。具体的状态码请见参考书目第二十页表1.3

收到返回消息之后，浏览器会将数据显示出来。如果有图像，则会进一步处理。

- 关于图像：
  
  网页中图像的本质就是存放在服务器上的一张图片。
  
  当网页中包含图像时，会在网页文件的相应位置嵌入表示图片文件的标签的控制信息。浏览器在显示文字时会搜索相应的标签，当遇到图片相关的标签时，会在屏幕上留出图像的空间，之后向Web服务器发送请求相关图片的消息，获得服务器上的相关图片，再填充到留出的空间上。
  
  这个过程与获得网页内容的过程是一致的，只需要将URI改为指向对应图片即可。
  
  如果一个网页中包含有多个图像，那么浏览器在浏览该网页时首先请求获得网页内容，之后请求获得第一张图片，然后请求获得第二张图片......以此类推，直到对网页内容补充完整。

在对于浏览器如何显示图像的解释过程中，蕴含着一个非常重要的概念，即：

**1条请求消息中只能写一个URI。如果需要获得多个文件，必须对每个文件单独发送1条请求。**

### 1-2 向DNS服务器查询Web服务器IP

#### 1-2-1 IP地址的基本知识

根据上文中的描述，浏览器在向Web服务器发送请求消息与接收响应消息之前，必须要查询到Web服务器的IP地址。所以在这里，简单的描述下IP地址的组成部分与相关知识。

说起IP地址时，都是基于TCP/IP的思路来搭建的，所以这里有必要说明一下TCP/IP的结构。

![](../data/picture/net/TCP_IP示意图.png)

如图所示。若干台电脑通过集线器连接到路由器上，路由器之间通过集线器再连接到上一层的路由器上，以此类推。凡是通过集线器连接起来的所有设备均属于同一个子网。

IP地址类似于现实生活中的门牌号，需要表明你在“XXX层XXX室”，其中“层”是分配给整个子网的，称为**网络号**；“室”分配给子网下的设备，称为**主机号**。网络号和主机号合起来，便组成了IP地址。可是如何将一个IP地址划分为网络号和主机号呢？就好像“3604”要理解成“第36楼第04室”还是“第3楼第604室”呢？这边涉及到一个非常重要的概念——子网掩码。

![](../data/picture/net/子网掩码在路由器中.png)

网络号与主机号一共是32比特，每8比特使用四位的十进制数表示，中间用". "隔开。格式类似于“192.168.50.1”。但是网络号与主机号的连接位置是不固定的，组件网络时用户可自行选择。这是就需要用子网掩码这个附加信息来表示出IP地址内部的结构。

子网掩码的形式有很多种，以下介绍几种常见类型：

- 10.11.12.13/255.255.255.0
  
  这种子网掩码的格式是与IP地址格式类似，但是左边的比特位都是1，右边的比特位都是0（比特都是2进制，四位比特最大值为1111，换算成10进制为255）IP地址中与子网掩码中1对应的部分即为网络号，与0对应的即为主机号。如下例：
  
  | IP地址 | 192 | 168 | 50  | 4   |
  | ---- | --- | --- | --- | --- |
  | 子网掩码 | 255 | 255 | 255 | 0   |
  
  上面的示例当中，“192.168.50”与子网掩码中比特位为1的部分对应，即为计算机的网络号；“4”与子网掩码中比特位为0的部分对应，即为计算机的主机号。

- 10.11.12.13/24
  
  这种格式中子网掩码只有一个数字“24”，这个表示子网掩码中左边有24位比特位为“1”，其余位为“0” 。这24个“1”每8位一组，换算为十进制即为“255.255.255”，补上剩下的“0”位，最终的子网掩码与第一种格式并无区别，均为“255.255.255.0”

关于IP地址的一个补充小知识：

- 192.168.50.0/255.255.255.0
  
  根据上面的知识，我们可以很容易的分出网络号与主机号。但是这里的主机号为“0”，这里可不是指第0台设备，而是指整个子网；

- 192.168.50.255/255.255.255.0
  
  同样的，这里的主机号全为“1”，也不是表示第255台机器，而是表示选中了该子网下全部的设备进行“群发”信息。这个动作被称作“**广播**”

#### 1-2-2 域名与IP地址并用的理由

这一节解释了为什么网站不仅使用域名作为标识符，也使用IP地址作为标识符。

如果仅使用域名作为标识符，虽然对于大家都很好记，但是如何让计算机去理解就变得十分困难。首先说字符长度，按照ASCII码表来说，一个字母长度大概在8个字符，仅“www.baidu.com”的长度就来到了104个字符，这远远大于IP地址的32字符；如果按照utf-8编码表的话，一个字母的长度在1-16之间不等，这个难度就更大了，计算机的解析压力会很大。同时网站的域名没有明确的格式限制，每个域名有多长取决于域名所有者，这对于DNS服务器很不友好（下文会介绍）。

如果仅使用IP地址作为标识符，计算机当然非常容易理解，因为格式更加规范，处理起来也更平稳。但是对于人来说就非常难记忆，想想看，每次上百度都要输入11位数，顺序输错了还上不去，更别说还有其他的网站需要记忆。有些人连自己的银行卡密码都会忘掉，更别说一堆11位数了。

所以计算机更容易理解IP地址，而人跟容易理解域名。那么在上网时就需要请一个“翻译”，把人们要去的网站域名翻译为电脑能看懂的IP地址，这个翻译机制就叫**DNS**（Domain Name System，域名服务系统），执行这个动作的设备就叫DNS服务器。

#### 1-2-3/4 Socket库提供查询IP地址的功能

在上一节我们已经知道了如果要查询IP地址就需要访问DNS服务器。通过DNS查询IP地址的操作称之为**域名解析**。发出和接收DNS服务器的消息时，在我们电脑上一定要有对应的客户端。这个客户端我们称为**DNS解析器**，或简称为解析器。

虽然被称为DNS解析器，实际上是一个非常“面向对象编程”的说法。解析器在电脑中就是一段程序，这段程序被包含在操作系统的Socket库中。通过Socket库可以调用系统的网络功能，其中包含有众多的发送和接收数据的程序组件。

查询IP地址时，浏览器调用Socket库中“gethostbyname("www.xxxx.com")”组件，该函数将域名对应的IP地址返回到指定的内存中。发送请求消息时浏览器会从指定内存中取出IP地址与请求消息一并交由操作系统处理发出。

#### 1-2-5 解析器的内部原理浅析

解析器在向DNS服务器请求域名对应的IP地址时会向DNS服务器发送查询消息。这个过程与向Web浏览器发送请求消息的过程类似。而解析器与浏览器本身不进行这项工作，两者同样都是要交由操作系统内部的**协议栈**完成。协议栈又称“协议驱动”、“TCP/IP驱动”，它可以控制网卡发出实际的物理信号。之后网卡收到返回信号之后，通过协议栈再将收到的IP地址放在指定的内存中。流程如下图所示：

![解析器与协议栈工作流程简图.png](..\data\picture\net\解析器与协议栈工作流程简图.png)

那么这时就可能有人会问：“那我们怎么知道DNS服务器的IP地址呢？”其实这个问题很简单。DNS服务器的IP地址作为TCP/IP的一个设置项目实现设置好的，不需要进行查询。在我们的操作系统中经常可以见到：

<img src="../data/picture/net/WIN10中DNS服务器地址设置.PNG" title="" alt="" data-align="center">

### 1-3 全世界DNS服务器的大接力

#### 1-3-1 DNS服务器的基本工作



#### 1-3-2 域名的层次结构



#### 1-3-3 寻找相应的DNS服务器并获取IP地址



#### 1-3-4 通过缓存加快DNS服务器的响应
